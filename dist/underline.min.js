"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();!function(t){t.fn.underline=function(){var t=this,i=arguments.length<=0||void 0===arguments[0]?{waitFor:null,initTimeOut:100}:arguments[0];setTimeout(function(){t.each(function(t,i){new e(i)})},i.initTimeOut)};var e=function(){function e(i){var n=this;_classCallCheck(this,e),this.element=i,this.refresh(),t(window).resize(function(){return n.refresh()})}return _createClass(e,[{key:"defineTextItems",value:function(e){var n=this;if(3==e.nodeType){var s=new i(e);s.words&&this.elements.push(s)}else e.childNodes.length>0&&t(e.childNodes).each(function(t,e){n.defineTextItems(e)})}},{key:"refresh",value:function(){this.elements=[],t("canvas",this.element).remove(),this.element.normalize(),this.defineTextItems(this.element),this.elements.forEach(function(t,e){t.init()})}}]),e}(),i=function(){function e(t){_classCallCheck(this,e),this.element=t,this.defineWords(),this.words&&this.defineRelativeContainer()}return _createClass(e,[{key:"init",value:function(){this.fixRelativeContainer(),this.createTmpLine(),this.processElement(),this.removeTmpLine(),this.unfixRelativeContainer()}},{key:"createTmpLine",value:function(){t(this.element).wrap("<span></span>"),this.tmpLine=this.element.parentNode}},{key:"removeTmpLine",value:function(){t(this.tmpLine).remove()}},{key:"fixRelativeContainer",value:function(){t(this.relativeContainer).css("height",window.getComputedStyle(this.relativeContainer,null).getPropertyValue("height"))}},{key:"unfixRelativeContainer",value:function(){this.relativeContainer.style.height=this.relativeContainerOldStyles.height}},{key:"defineWords",value:function(){this.words=this.element.textContent.replace(/[\n|\s+?]/g," ").match(/\s?[^\s-]+-?\s?/g)}},{key:"defineRelativeContainer",value:function(){for(this.relativeContainer=this.element.parentNode;("block"!=window.getComputedStyle(this.relativeContainer,null).getPropertyValue("display")||"relative"!=window.getComputedStyle(this.relativeContainer,null).getPropertyValue("position"))&&"HTML"!==this.relativeContainer.parentNode.nodeName;)this.relativeContainer=this.relativeContainer.parentNode;this.relativeContainerOldStyles={height:this.relativeContainer.style.height}}},{key:"processElement",value:function(){var t,e=this.words.slice(0);this.element.nodeValue="";do{this.tmpLine.textContent=e[0],t=this.tmpLine.getBoundingClientRect().height;for(var i=0;i<=e.length;i++){if(this.tmpLine.textContent=e.slice(0,i).join(""),Math.floor(this.tmpLine.getBoundingClientRect().height)>Math.floor(t)){this.tmpLine.textContent=e.splice(0,i-1).join(""),this.generateUnderline();break}e.length==i&&(this.tmpLine.textContent=e.splice(0,i).join(""),this.generateUnderline())}}while(e.length>0)}},{key:"generateUnderline",value:function(){var e=new n(this.tmpLine);e.createLine(),e.createHoles(),t(this.tmpLine.childNodes).insertBefore(this.tmpLine)}}]),e}(),n=function(){function e(t){_classCallCheck(this,e),this.element=t,this.defineStyles(),this.text=this.element.innerText,this.createCanvas(),this.defineCanvasStyles()}return _createClass(e,[{key:"createCanvas",value:function(){var e=t(this.element).offset();this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),window.devicePixelRatio||(window.devicePixelRatio=window.screen.deviceXDPI/window.screen.logicalXDPI),this.ratio=window.devicePixelRatio,this.canvas.width=this.styles.width*this.ratio,this.canvas.height=this.styles.height*this.ratio,this.canvas.style.top=e.top+"px",this.canvas.style.left=e.left+"px",this.canvas.style.width=this.styles.width+"px",this.canvas.style.position="absolute",this.element.appendChild(this.canvas)}},{key:"createLine",value:function(){this.textWidth=this.ctx.measureText(this.text).width,this.ration>1&&(this.textWidth*=this.ratio),this.startPoint={x:0,y:this.underlinePosition},this.endPoint={x:this.textWidth,y:this.underlinePosition},this.maxGrabDistance=2*this.strokeWidth,this.maxControlDistance=6*this.strokeWidth,this.ctx.lineWidth=this.strokeWidth,this.ctx.strokeStyle=this.styles.fontColor,this.ctx.beginPath(),this.ctx.moveTo(this.startPoint.x,this.startPoint.y),this.ctx.lineTo(this.endPoint.x,this.endPoint.y),this.ctx.globalCompositeOperation="source-over",this.ctx.stroke()}},{key:"createHoles",value:function(){this.ctx.font=this.font,this.ctx.textBaseline="top",this.ctx.globalCompositeOperation="destination-out",this.ctx.lineWidth=2*this.ratio+3.6*this.strokeWidth,this.ctx.strokeStyle="blue",this.ctx.beginPath();var t=navigator.userAgent.toLowerCase().indexOf("firefox")>-1?.1*this.ctx.canvas.scrollHeight:0;this.ctx.strokeText(this.text,-.2,t),this.ctx.fillStyle="transparent",this.ctx.beginPath(),this.ctx.fillText(this.text,-.2,t)}},{key:"defineCanvasStyles",value:function(){this.ctx.font=this.font=this.styles.fontStyle+" "+this.multiplyValue(this.styles.fontSize,this.ratio)+" "+this.styles.fontFamily;var t=this.ctx.measureText(".").width;this.strokeWidth=t/12,this.strokeColor=this.styles.fontColor,this.underlinePosition=parseFloat(this.styles.height)*this.ratio*(1-this.styles.baselinePositionRatio+.4*this.styles.baselinePositionRatio)+this.strokeWidth/2;var e=this.optimalStrokeWidthPos(this.strokeWidth,this.underlinePosition);this.strokeWidth=e.strokeWidth,this.underlinePosition=e.posY}},{key:"defineStyles",value:function(){this.styles={baselinePositionRatio:this.baselineRatio(),lineHeight:parseFloat(window.getComputedStyle(this.element,null).getPropertyValue("line-height")),fontFamily:window.getComputedStyle(this.element,null).getPropertyValue("font-family"),fontSize:window.getComputedStyle(this.element,null).getPropertyValue("font-size"),fontColor:window.getComputedStyle(this.element,null).getPropertyValue("color"),fontStyle:window.getComputedStyle(this.element,null).getPropertyValue("font-style"),width:this.element.getBoundingClientRect().width,height:this.element.getBoundingClientRect().height,parentWidth:this.element.parentNode.getBoundingClientRect().width,offsetLeft:this.element.offsetLeft}}},{key:"baselineRatio",value:function(){var t=this.element||document.body,e=document.createElement("div");e.style.display="block",e.style.position="absolute",e.style.bottom="0",e.style.right="0",e.style.width="0px",e.style.height="0px",e.style.margin="0",e.style.padding="0",e.style.visibility="hidden",e.style.overflow="hidden";var i=document.createElement("span"),n=document.createElement("span");i.style.fontSize="0px",n.style.fontSize="2000px",i.innerHTML="X",n.innerHTML="X",e.appendChild(i),e.appendChild(n),t.appendChild(e);var s=i.getBoundingClientRect(),o=n.getBoundingClientRect();t.removeChild(e);var l=s.top-o.top,h=o.height;return 1-l/h}},{key:"optimalStrokeWidthPos",value:function(t,e){return 1>t?e=Math.round(e-.5)+.5:t>=1&&(t=Math.round(t),e=t%2?Math.round(e-.5)+.5:Math.round(e)),{strokeWidth:t,posY:e}}},{key:"multiplyValue",value:function(t,e){var i=t,n=e,s=i.match(/(\d*\.?\d*)(.*)/);return s[1]*n+s[2]}}]),e}()}(jQuery);